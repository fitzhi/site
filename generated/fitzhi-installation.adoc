== INSTALLATION OF FITZHI
:nofooter:

There are currently 3 ways to install Fitzhì on your environments.

=== USING FITZHI IN A DOCKER CONTAINER

The easiest way to install Fitzhi is to use a preinstalled version of Fitzhi inside a Docker container.

You can download a container directly from http://hub.docker.com/u/fitzhi/[window=_blank]. 
The current tag is 1.7.

[source, shell]
----
docker pull fitzhi/application:1.7
----

The container provides :

- a `Java` `Spring` Rest server 
- an `Angular` application
- an `nginx` instance 
- a `Git` client

[.text-justify] 
Fitzhi might be linked with your Sonar server, if any. This component is not mandatory for the proper functioning of fitzhi
Sonar server is considered a useful source of information to assess the quality of projects.
If you want to link the container with your Sonar instance, you has to provide some connection settings at startup.
These settings will allow the `reverse-proxy` deployed in the container to access your Sonar server [.underline]#from inside#.

.RESOLUTION OF THE SONAR URL
****
[.text-justify] 
The URL given to the container must be resolvable from inside the environment that will host the application. If you test Fitzhi from your local machine and the URL https://mysonar:9000 is reachable from there, then you can pass this url. Otherwise check that the destination of the container will resolve the given url. +
The container currently does only support **one** Sonar server. Please install Fitzhi on your local environments if you have multiple Sonar servers in your IT.
****

**The parameters are :**

[cols="1,1"]
|===
| **Name** | **Description**

|urlSonarServer
|URL where the Sonar server is deployed.

|login
|The recommended authentification credential : the Sonar token login. This token has been generated by the Sonar security module.

|user
|The alternative connection mode : +
The basic authentication credential : user/password. +
This user is required to be identified by Sonar. Default is "admin"

|password
|Password required to be identified by Sonar. +
This property is mandatory if the connection mode is the user/password mode.

|===

Fitzhi shares its internal deployment directory `/fitzhi/deploy/` with your host machine. +
This directory contains the server, the settings and the referential and application data of Fitzhì +
You should first create a volume to store the Fitzhi data. +
The content of the volume is described link:#_deployment_description[here].
[source, shell]
----
docker volume create fitzhi-data
----

To start the application in the Sonar recommended way, you just can type :

[source, shell]
----
docker run --name fitzhi \
-e "urlSonarServer=http://yourSonarHostname:9000" \
-e "login=youLoginTokenToSonar" \
-v fitzhi-data:/fitzhi/deploy/ \
-p 80:80 -d --rm fitzhi/application:1.7
----

To start the application in an alternative way, you can type :

[source, shell]
----
docker run --name fitzhi \
-e "urlSonarServer=http://yourSonarHostname:9000" \
-e "user=youSonarUser" \
-e "password=yourSonarPassword" \
-v fitzhi-data:/fitzhi/deploy/ \
-p 80:80 -d --rm fitzhi/application:1.7
----

=== INSTALLATION ON YOUR LOCAL ENVIRONMENTS

==== INSTALLATION OF THE BACKEND SERVER

To deploy the backend on a local server, you first have to download the archive of Fitzhì.

[source, shell]
----
curl https://spoq.fitzhi.com/release/back-fitzhi.zip --output deploy.zip
tar xvf deploy.zip
----

To start the server, you just have to type :
[source, shell]
----
cd ./deploy/backend-fitzhi/
java -Xmx1g -jar fitzhi.jar --spring.profiles.active=HTTP
----

NOTE: The Backend server will listen by default the port number `8080`.

TIP: To check the server status, and verify that the server has been successfully launched, just visit the url http://localhost:80/api/test/ping[window=_blank] , or http://hostname:80/api/test/ping  +
A text **Pong** response is expected.

==== INSTALLATION OF THE FRONTEND SERVER

The Angular project has to be downloaded. A local webserver is necessary to publish the application. +
Our documentation proposes the use of `nginx` for this task, among others.

[source, shell]
----
curl https://spoq.fitzhi.com/release/front-fitzhi.zip --output spoq.zip
mkdir spoq
cd spoq
tar xvf ../spoq.zip
----

WARNING: Your internet browser will have to handle 2 servers simultaneously. +
Therefore your will face some CORS issues. So please read the chapter related to the configuration of NGINX.


=== **BUILD** AND INSTALLATION ON YOUR LOCAL ENVIRONMENTS

First you need to export the GitHub repository.

.Download the source of Fitzhì
[source, shell]
----
git clone https://www.github.com/fitzhi/application.git
rm -rf .git
----

A directory Application will be downloaded with this content :

* front-fitzhi (the Angular front-end project)
* back-fitzhi  (the Spring back-end project)

=== BUILDING THE BACKEND SERVER

The building script requires the following prerequisites:::
* Java 11 or higher
* Maven 3 or higher
* Git 2 or higher installed on the backend server

The build of the backend is very simple. Just type :

[source, shell]
----
cd application
./init.sh
----

To start the back-end of Fitzhì, just type:
[source, shell]
----
./run.sh HTTP (or HTTPS)
----

NOTE: To test if the server is correctly started, just visit the url http://localhost:8080/api/test/ping[window=_blank] , or http://hostname:8080/api/test/ping  +
A **Pong** response is expected.


=== BUILDING THE FRONTEND CLIENT

The easiest installation involved no-installation. +
The last stable release of front-fitzhì is available here https://fitzhi.github.io/spoq[window=_blank]. +
This URL hosts only a static web server which delivers JS files. So just go there.

If you prefer to deploy the front-end on-premise, like any other Angular application. +
Just type 
[source, shell]
----
cd front-fitzhi
npm install
ng build --prod 
----

A *dist* (by default) directory will be created. +
Just copy everything within the output folder to a folder on your server.
For more precision, just RTFM, https://angular.io/guide/deployment

WARNING: Your internet browser will have to handle 2 servers simultaneously.
Therefore your will face some CORS issues. So read the chapter further on the subject of CORS.

[.text-justify] 
You can copy the deploy directory on a remote server, or leave it, on your machine, for testing purpose.
The back-end URL, therefore, will be http://localhost:8080 if you start the server in HTTP mode, and 
http://localhost:8443 in HTTPS mode.


== THE BROWER AND THE CORS ISSUE

IMPORTANT: First of all, you do not have to read this chapter if you are using the Docker container.
The reverse-proxy is already pre-installed and pre-configured.

[.text-justify] 
If you are not familiar with the mechanism of CORS, you can refer to https://en.wikipedia.org/wiki/Cross-origin_resource_sharing[this simple presentation, window=_blank]. +
This protection feature is activated inside your browser, when your executes multiple cross-domain requests. +
With Fitzhì, you have 2 cross domain sources.

Therefore you might have to configure 3 types of servers.
* the HTTP server of the Angular application
* the backend of Fitzhì
* The Sonar server(s) available on your network.

[.text-justify] 
The software `NGINX` is not a prerequisite, you can use either `Apache`, or `Haproxy`, or any other solution as well. The procedure below is just limited to NGINX.

[.text-justify] 
First you need to download link:http://nginx.org/en/docs/njs/index.html[NGINX, window=_blank] and follow the instuctions.

[.text-justify] 
After the installation, the configuration is very simple. Depending on your distribution, you might have to configure the **nginx.conf** file, or the **default** file as below. 

**3 entries have to be declared :**

- the full path of the Angular distribution files
- the URL behind which the backend server will be reachable
- The URL behind which your Sonar server is reachable from your environment

With these settings, your appplication will be available at http://localhost:8081
[source, json]
----
server {
	listen       8081;
	server_name  localhost;

	location / {
		root   /the/path/to/your/application/dir;
		index  index.html index.htm;
	}

	location /api {
		  proxy_pass http://localhost:8080;

		  proxy_set_header Host $http_host;
		  proxy_set_header X-Real-IP $remote_addr;
		  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		  proxy_set_header X-Forwarded-Proto $scheme;

		  # When we create new entitiy like 'project',the API returns a 201 response with a 'location' header
		  # We add this setting to ensure that the https scheme is present in the response 
		  # cf. http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_redirect
		  proxy_redirect http://$host https://$host;

		  # These 3 settings are set to enable the event-stream flow from the server
		  # https://stackoverflow.com/questions/13672743/eventsource-server-sent-events-through-nginx
		  proxy_set_header Connection '';
		  proxy_http_version 1.1;
		  chunked_transfer_encoding off;
	}
	
	location ~ ^/sonar/(.+) {
		# We rewrite and remove the sonar directory in the path.
		rewrite ^/sonar/(.+)$ /$1 break;

		proxy_pass http://localhost:9000;
		
		proxy_set_header Host $http_host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
	}
}
----

CAUTION: The sonar-servers.json file contains the list of all Sonar servers available on your network. This file is hosted on the Fitzhi backend server. It should contain the URL(s) of the Sonar instance(s) FROM THE PERSPECTIVE OF THE WEB BROWSER. In the case above, your Sonar server will be declared at http://localhost:8081/sonar.

== DEPLOYMENT DESCRIPTION

The backend solution is composed of these directories.

|===
|**Directory** |**Description**

|deploy
|Main deployment directory
|deploy/backend-fitzhi
|This directory contains executable `fitzhi.jar`` and the `application.properties` file. +
Specific settings for fitzhi are declared in this file.
|deploy/data
|The data store of fitzhì
|deploy/data/application
|The data directories where your corporate data will be stored (e.g. staff.json, project.json & skill.json). +
All of your updates will be stored there.
|deploy/data/referential
|The referential data which contains the static data used by the application
|deploy/data/repos
|The directory which contains all local GIT repositories
|deploy/docker
|The files necessary for the container to run correctly.
|===

